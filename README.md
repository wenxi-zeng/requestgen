# Request Generator
- [Request Generator](#request-generator)
  - [0. Update Notes (10/28/2019)](#0-update-notes-10282019)
    - [10/28/2019](#10282019)
    - [10/26/2019](#10262019)
  - [1. Test the Sample Code](#1-test-the-sample-code)
    - [1.1 Build project](#11-build-project)
    - [1.2 Run the jar](#12-run-the-jar)
      - [Random request generation](#random-request-generation)
      - [Request generation with fixed order](#request-generation-with-fixed-order)
      - [File propagator](#file-propagator)
      - [Smart generator](#smart-generator)
  - [2. Use the Sample Code](#2-use-the-sample-code)
      - [Implement callback](#implement-callback)
      - [Declare a generator](#declare-a-generator)
      - [Start generator service](#start-generator-service)
      - [Save Dynamic Tree to File](#save-dynamic-tree-to-file)
      - [Declare and start file propagator](#declare-and-start-file-propagator)
  - [3. The Configuration File](#3-the-configuration-file)

## 0. Update Notes (10/28/2019)

### 10/28/2019

Changes to <code>SmartRequestGenerator</code>:

* add <code>saveDynamicTreeToFile</code> method to store the dynamic tree to file
* add sample usage code to <code>example/RegularClient.java</code>. You can also find the usage and explanation [here](#save-dynamic-tree-to-file)

Bug fix:

* fix the bug that changes to the configuration file does not take effect
* fix generator illegal bounds error when all files are deleted 

### 10/26/2019

Two components are added:

* [File propagator](#file-propagator): basically a generator genrates only <code>CREATE_FILE</code> request.
* [Smart request generator](#smart-generator): a generator that maintains a copy of the directoies that propagated to the file system, thus generating requests based on its knowledge of directories structure.

Configuration file changes:

* <code>request_ratio</code>: enhancement of <code>read_write_ratio</code> with more predefined request types. The ratio should be declared in the order of <code>READ, WRITE, DELETE, CREATE_FILE, RMDIR, LS, CREATE_DIR</code>. For example: <code>0.25,0.25,0.25,0.25,0,0,0</code>


**Please make sure your configuration file is updated before using the updated code** Things that are not important to the phase 2 project have been striked out in the following description.

You can download the data file in [here](https://1drv.ms/f/s!AsSspD1SzIh7vOoG1daUgVpQE07k3A)

## 1. Test the Sample Code

### 1.1 Build project

Build the project by using <code>mvn install</code>. The artifact shall be generated under <code>target</code>

### 1.2 Run the jar

Make sure <code>resources</code> folder is placed at the same folder with the <code>jar</code> file.

<del>
#### Random request generation

The following command generate random request. You can specify the <code>number of requests</code> needs to be generated, otherwise the generator uses the value specified in the configurate file (<code>resources/config.properties</code>) ***NOTE:*** the number of requests is specified per thread.

```bash
java -jar RequestGenerator.jar -r <filename> [number of requests]
```

#### Request generation with fixed order

First, use the following command to generate a dataset.

```bash
java -jar RequestGenerator.jar -f <src> <dataset>
```

Then feed the generator with the dataset: 

```bash
java -jar RequestGenerator.jar -s <dataset>
```
</del>

#### File propagator

The file propagator uses [data file](https://1drv.ms/f/s!AsSspD1SzIh7vOoG1daUgVpQE07k3A) to generate <code>CREATE_FILE</code> requests. At the same time produces a rank file, which can be used later for request generator with zipf distribution.

```bash
java -jar RequestGenerator-1.0-SNAPSHOT.jar -p <data file> <output rank file>
```

#### Smart generator

The smart generator can take three parameters

* static file: <code>required</code>. If only [static file](https://1drv.ms/f/s!AsSspD1SzIh7vOoG1daUgVpQE07k3A) is given, the generator won't genrate <code>DELETE</code> request.
* dynamic file: <code>optional</code>. [dynamic file](https://1drv.ms/f/s!AsSspD1SzIh7vOoG1daUgVpQE07k3A) should be the same file that used for file propagator, and should be either the same as the static file or a portion of the static file.
* rank file: <code>optional</code>. Rank file is the file generated by the file propagator

```bash
java -jar RequestGenerator-1.0-SNAPSHOT.jar -m <static file> [dynamic file] [rank file]
```


## 2. Use the Sample Code

#### Implement callback

The callback provides a generated request and the id of which thread generates it.

```java
    RequestThread.RequestGenerateThreadCallBack callBack = new RequestThread.RequestGenerateThreadCallBack() {
        @Override
        public void onRequestGenerated(Request request, int threadId) {
            System.out.println("thread[" + threadId + "]: " +  request);
        }
    }
```

#### Declare a generator

<del>There are two types of generator: <code>ClientRequestGenerator</code> and <code>SequentialRequestGenerator</code>, corresponding to what has been described on [section 1.2](#12-run-the-jar).</del> The following code demostrates how to declare <code>SmartRequestGenerator</code>. You can implement your own generator by extending the abstract class <code>RequestGenerator</code>.

```java
    RequestGenerator generator = new SmartRequestGenerator("staticFile", 
                                                            "dynamicFile", 
                                                            "rankFile");
```

#### Start generator service

Pass the <code>callback</code> and the <code>generator</code> to the service. Parameters <code>numThreads</code>, <code>interarrivalRate</code> and <code>numOfRequests</code> can be read from the configuration file

```java        
    RequestService service = new RequestService(numThreads,
            interarrivalRate,
            numOfRequests,
            generator,
            callBack);

    service.start();
```

#### Save Dynamic Tree to File

The dynamic tree file is the file that you used for <code>FilePropagator</code> to populate files to the file system. That means the dynamic tree file has all the data in the file system.

If you use <code>SmartRequestGenerator</code> with dynamic tree file, the generator keeps tracking the changes made to the file system. For example, when a <code>DELETE</code> or <code>CREATE_FILE</code> request is generated, the tree removes or adds the correspoding file. After runing for a while, the file system may be created a lot of new files or deleted a lot of exisitng files. You want to save the new tree for next time to use. Thus, you can use <code>saveDynamicTreeToFile</code> to do this.

```java        
    ((SmartRequestGenerator)generator).saveDynamicTreeToFile("dynamicTree.txt");
```

#### Declare and start file propagator

<code>FSPropagator</code> takes the same callback interface as parameter.

```java        
    FSPropagator propagator = new FSPropagator("src", "rankFile", callback);

    propagator.start();
```

## 3. The Configuration File

The configuration file contains the following parameters:

* <code>read_write_inter_arrival_rate</code>: uses possion distribution. rate = number of requests / total time in ms. For example, 5000 requests in 18 minutes, the rate would be = 5000 / (18 * 60 * 1000) = 0.00463
* <code>request_distribution</code>: value can be [uniform|zipf]
* <code>read_write_ratio</code>: percentage of read and write, sum to 1
* <code>alpha</code>: used for zipf
* <code>number_threads</code>
* <code>num_of_requests</code>: number of requests per thread to generate, use -1 for infinite requests
* <code>request_ratio</code>: enhancement of <code>read_write_ratio</code> with more predefined request types. The ratio should be declared in the order of <code>READ, WRITE, DELETE, CREATE_FILE, RMDIR, LS, CREATE_DIR</code>. For example: <code>0.25,0.25,0.25,0.25,0,0,0</code>
